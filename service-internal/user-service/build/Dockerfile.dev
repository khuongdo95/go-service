# Stage 1: Build binary
FROM golang:1.24-alpine AS builder
WORKDIR /app

# âœ… Install git (and any other needed tools)
RUN apk add --no-cache git ca-certificates bash curl tar

ARG service=user
COPY . .

# Add private repo auth

RUN go mod tidy
RUN CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -mod=readonly -o /tmp/main ./cmd/app/main.go

# Stage 2: Runtime
FROM golang:1.24-alpine

RUN apk --no-cache add ca-certificates bash curl

# Install Air (hot reloader)
RUN mkdir -p /usr/local/bin \
  && curl -sSfL https://raw.githubusercontent.com/air-verse/air/master/install.sh \
  | sh -s -- -b /usr/local/bin \
  && chmod +x /usr/local/bin/air

ARG env=dev
ARG service
COPY --from=builder /tmp/main /tmp/main
COPY --from=builder /go/pkg/mod /go/pkg/mod
COPY .air.toml /configs/.air.toml

WORKDIR /app

EXPOSE 8081

CMD ["air", "-c", "/configs/.air.toml"]